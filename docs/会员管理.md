# 会员管理白皮书

> **版本**: v1.0
> **更新时间**: 2025-11-27
> **用途**: 会员等级、升降级、体验会员规则参考文档

---

## 一、会员定义

**会员 = 注册用户**

所有注册用户都是会员，会员体系分为10个等级：VIP0 ~ VIP9

---

## 二、体验会员规则

### 2.1 用户赠送体验会员

**规则**: 用户可以赠送自己同级别的体验会员

**业务逻辑：**
1. A用户（VIP3）可以赠送B用户VIP3体验会员
2. 体验会员有固定期限（由平台配置，如7天）
3. B用户接受后，从次日开始计算，当天不计入
4. 如果B用户已有同级或更高级VIP，无法接受赠送

**配置参数：**
```typescript
{
  userGiftTrialDays: 7  // 用户赠送体验会员期限（可配置，天）
}
```

---

### 2.2 商家赠送体验会员

**规则**: 商家可以赠送VIP1~3体验会员

**业务逻辑：**
1. 商家可赠送等级：VIP1、VIP2、VIP3
2. 体验会员有固定期限（由平台配置，如7天）
3. 用户接受后，从次日开始计算，当天不计入
4. 如果用户已有同级或更高级VIP，无法接受赠送

**配置参数：**
```typescript
{
  merchantGiftTrialDays: 7,  // 商家赠送体验会员期限（可配置，天）
  merchantMaxGiftLevel: 3,   // 商家可赠送的最高等级（固定为3）
}
```

---

### 2.3 时间计算规则

**规则**: 时间从用户接受赠送后开始计算，当天不计入

**示例：**
```
赠送时间：2025-01-10 14:30:00
用户接受：2025-01-12 10:00:00
生效时间：2025-01-13 00:00:00  （接受后次日0点）
体验期限：7天
到期时间：2025-01-19 23:59:59  （生效后7天）
```

**字段定义：**
```typescript
{
  invitedAt: '2025-01-10 14:30:00',     // 赠送时间
  acceptedAt: '2025-01-12 10:00:00',    // 接受时间
  effectiveAt: '2025-01-13 00:00:00',   // 生效时间（次日0点）
  trialDays: 7,                          // 体验期限
  expiresAt: '2025-01-19 23:59:59',     // 到期时间
}
```

---

### 2.4 等级冲突检查

**规则**: 如果已有同级别或更高级的VIP，无法成功接受赠送

**检查逻辑：**
```typescript
function canAcceptTrialMember(user: User, giftLevel: number): boolean {
  // 取用户当前最高等级（正式会员或体验会员中的高值）
  const currentHighestLevel = Math.max(user.formalLevel, user.trialLevel || 0)

  // 赠送等级必须高于当前等级
  return giftLevel > currentHighestLevel
}
```

**拒绝场景：**
- 用户当前VIP3，赠送VIP2 → 拒绝（等级相同或更低）
- 用户当前VIP3，赠送VIP3 → 拒绝（等级相同）
- 用户当前VIP3，赠送VIP4 → 接受（等级更高）

---

### 2.5 体验/正式会员并行

**规则**: 体验会员和正式会员会同时计算时间，会员等级取更高等级展示

**数据结构：**
```typescript
{
  // 正式会员
  formalLevel: 3,                    // 正式会员等级
  formalValidityDate: '2026-10-15',  // 正式会员有效期

  // 体验会员
  trialLevel: 5,                     // 体验会员等级
  trialValidityDate: '2025-12-05',   // 体验会员有效期

  // 当前展示（取高值）
  currentLevel: 5,                   // max(3, 5) = 5
  currentLevelName: 'VIP5',
}
```

**计算逻辑：**
```typescript
function calculateCurrentLevel(user: User): number {
  const now = new Date()

  // 检查正式会员是否过期
  const formalLevel = new Date(user.formalValidityDate) > now
    ? user.formalLevel
    : 0

  // 检查体验会员是否过期
  const trialLevel = (user.trialLevel && new Date(user.trialValidityDate) > now)
    ? user.trialLevel
    : 0

  // 取高值
  return Math.max(formalLevel, trialLevel)
}
```

---

## 三、会员折扣规则

### 3.1 折扣配置规则

**平台定义**: 各VIP等级的会员折扣（如VIP1=95%，VIP2=90%等）

**商户必须接受**: 商户不能拒绝使用会员折扣

**商户可设置更优惠折扣**:
- 商户可针对平日/周末/节假日设置**更低的折扣**（更优惠）
- 商户折扣必须 ≤ 平台折扣（如平台95%，商户可设90%、85%等）

**示例：**
```
平台设定：VIP1会员折扣 = 95%

商家A设置：
- 平日：90%（比平台更优惠5%）
- 周末：95%（使用平台折扣）
- 节假日：95%（使用平台折扣）

商家B设置：
- 平日：95%（使用平台折扣）
- 周末：92%（比平台更优惠3%）
- 节假日：95%（使用平台折扣）
```

**折扣计算逻辑：**
```typescript
// 订单最终折扣 = min(平台折扣, 商户折扣)
实际折扣 = Math.min(平台VIP1折扣, 商户当日折扣)
```

---

## 四、升降级策略（万豪模式）

### 4.1 年度重置机制

**规则**: 每年1月1日0点，清空所有当年升级、保级的间夜数

**定时任务**: 每年1月1日 00:00:00 执行

**重置内容：**
```typescript
{
  yearUpgradeNights: 0,      // 当年升级间夜数 → 0
  upgradedThisYear: false,   // 当年升级标记 → false
}
```

**不重置内容：**
- `totalNights`: 累计总间夜数（保持累加）
- `maintainNights`: 保级间夜数（继续计数）

---

### 4.2 升级机制

**规则**: 完成升级所需间夜数，立即升1级，当年无保级要求

**触发时机**: 用户订单离店后，系统检测间夜数

**升级逻辑：**
```typescript
// 订单离店后
totalNights += orderNights
yearUpgradeNights += orderNights

// 检查升级条件
if (totalNights >= nextLevelUpgradeNights) {
  currentLevel += 1
  upgradedThisYear = true
  validityDate = 次年12月31日
  maintainNights = 0  // 重置保级计数器
}
```

**关键字段：**
```typescript
{
  totalNights: 50,           // 累计总间夜
  yearUpgradeNights: 15,     // 当年升级间夜
  upgradedThisYear: true,    // 当年已升级（无需保级）
}
```

---

### 4.3 保级机制

**规则**: 当年无升级记录，12月30日23点59分检测保级，未达标降1级

**定时任务**: 每年12月30日 23:59:00 执行

**保级逻辑：**
```typescript
// 12月30日23:59检测
if (!upgradedThisYear) {
  if (maintainNights >= currentLevelMaintainNights) {
    // 达标：保持当前等级
    validityDate = 次年12月31日
  } else {
    // 未达标：降1级
    currentLevel = Math.max(0, currentLevel - 1)
    validityDate = 次年12月31日
  }

  // 重置保级计数器
  maintainNights = 0
}
```

---

### 4.4 间夜数独立计算

**规则**: 升级间夜数、保级间夜数，单独计算

**字段说明：**
```typescript
{
  totalNights: number,        // 累计总间夜（用于升级判断，只增不减）
  yearUpgradeNights: number,  // 当年升级间夜（每年1月1日清零）
  maintainNights: number,     // 保级间夜（升级后清零，年末检测后清零）
}
```

**示例：**
```
用户当前VIP2，累计30晚

2025年：
- 1月1日：yearUpgradeNights = 0, maintainNights = 0
- 3月完成订单3晚：totalNights=33, yearUpgradeNights=3, maintainNights=3
- 6月达到VIP3升级条件（累计50晚）：升级为VIP3, maintainNights=0
- 12月30日：upgradedThisYear=true，无需保级检测

2026年：
- 1月1日：yearUpgradeNights=0, upgradedThisYear=false
- 全年未升级，12月30日检测保级：maintainNights需>=10晚
```

---

## 五、商户折扣配置字段

### 5.1 商户会员折扣配置

```typescript
interface MerchantMemberDiscountConfig {
  hotelId: string
  hotelName: string

  // 各等级折扣设置
  discounts: {
    level: number                      // VIP等级
    levelName: string                  // 等级名称
    platformDiscount: number           // 平台折扣（只读，不可修改）
    weekdayDiscount: number            // 平日折扣（可编辑，必须 <= platformDiscount）
    weekendDiscount: number            // 周末折扣（可编辑，必须 <= platformDiscount）
    holidayDiscount: number            // 节假日折扣（可编辑，必须 <= platformDiscount）
  }[]

  updatedAt: string
}
```

**校验规则：**
```typescript
weekdayDiscount <= platformDiscount
weekendDiscount <= platformDiscount
holidayDiscount <= platformDiscount
```

**默认值：**
- 初始化时，三种折扣默认值 = 平台折扣（无额外优惠）

---

## 六、核心字段定义

### 6.1 用户会员信息

```typescript
interface UserMemberInfo {
  userId: string
  userNickname: string
  phone: string

  // 当前展示等级（体验和正式中取高值）
  currentLevel: number
  currentLevelName: string

  // 正式会员
  formalLevel: number                  // 正式会员等级
  formalValidityDate: string           // 正式会员有效期

  // 体验会员
  trialLevel: number | null            // 体验会员等级（null=无体验会员）
  trialValidityDate: string | null     // 体验会员有效期

  // 间夜计数器
  totalNights: number                  // 累计总间夜（只增不减）
  yearUpgradeNights: number            // 当年升级间夜（每年1月1日清零）
  maintainNights: number               // 保级间夜（升级后清零）

  // 年度标识
  upgradedThisYear: boolean            // 当年是否已升级（升级后=true，无需保级）

  validityDate: string                 // 会员有效期（正式或体验中较晚的日期）
  pointsBalance: number
  registeredAt: string
}
```

---

### 5.2 会员邀请记录

```typescript
interface MemberInvitationRecord {
  id: string

  // 赠送信息
  vipLevel: number                     // 赠送的VIP等级
  isTrial: boolean                     // 是否为体验会员
  trialDays: number | null             // 体验期限（天，正式会员为null）

  // 时间信息
  invitedAt: string                    // 赠送时间
  acceptedAt: string | null            // 接受时间
  effectiveAt: string | null           // 生效时间（接受后次日0点）
  expiresAt: string | null             // 到期时间

  // 用户信息
  inviteeId: string                    // 受邀人ID
  inviterRole: 'user' | 'merchant'     // 赠送人角色
  inviterId: string                    // 赠送人ID

  // 状态
  status: 'pending' | 'accepted' | 'rejected' | 'expired'

  userRegisteredAt: string
}
```

---

### 5.3 会员等级升级规则

```typescript
interface MemberLevelUpgradeRule {
  level: number                        // VIP等级（0-9）
  levelName: string                    // 等级名称
  upgradeNights: number                // 升级所需累计间夜
  maintainNights: number               // 保级所需间夜（年度周期）
  validityMonths: number               // 会员有效期（月）
  benefits: string                     // 会员权益说明
  updatedAt: string
}
```

---

### 5.4 商户折扣配置

```typescript
interface MemberLevelDiscountRule {
  level: number
  levelName: string

  // 平台设定范围
  platformBaseDiscount: number         // 平台基础折扣（如0.95=95%）
  merchantDiscountMin: number          // 商户最低折扣（如0.8=80%）
  merchantDiscountMax: number          // 商户最高折扣（等于platformBaseDiscount）

  updatedAt: string
}

interface MerchantDiscountConfig {
  hotelId: string
  hotelName: string

  // 各等级折扣设置
  discounts: {
    level: number
    discount: number                   // 商户设置的折扣（默认=最大值）
  }[]

  updatedAt: string
}
```

---

## 六、升降级详细规则

### 6.1 升级规则

**触发条件**: 累计间夜数 >= 下一级所需间夜数

**执行时机**: 用户订单状态变为 `checked_out`（已离店）后立即检测

**升级效果：**
1. 等级+1
2. 设置 `upgradedThisYear = true`（当年无需保级）
3. 更新有效期为次年12月31日
4. 重置保级间夜计数器 `maintainNights = 0`

**示例：**
| 等级 | 升级所需累计间夜 | 保级所需年度间夜 |
|------|----------------|----------------|
| VIP0 → VIP1 | 5晚 | - |
| VIP1 → VIP2 | 15晚 | 5晚 |
| VIP2 → VIP3 | 30晚 | 10晚 |
| VIP3 → VIP4 | 50晚 | 15晚 |
| ... | ... | ... |

---

### 6.2 保级规则

**触发条件**: 当年无升级记录 (`upgradedThisYear = false`)

**检测时机**: 每年12月30日 23:59:00

**保级逻辑：**
```
if (当年已升级) {
  无需保级检测，直接续期
} else {
  if (保级间夜 >= 保级要求) {
    保持当前等级
  } else {
    降1级（最低VIP0）
  }
}
```

---

### 6.3 年度重置

**触发时机**: 每年1月1日 00:00:00

**重置内容：**
```typescript
{
  yearUpgradeNights: 0,      // 清空当年升级间夜
  upgradedThisYear: false,   // 重置升级标记
}
```

**保持不变：**
```typescript
{
  totalNights,               // 累计总间夜（继续累加）
  maintainNights,            // 保级间夜（继续累加）
  currentLevel,              // 会员等级
  validityDate,              // 会员有效期
}
```

---

## 七、配置参数汇总

| 参数名称 | 字段名 | 默认值 | 说明 |
|---------|--------|--------|------|
| 用户赠送体验期限 | `userGiftTrialDays` | 7 | 用户赠送体验会员有效天数（可配置） |
| 商家赠送体验期限 | `merchantGiftTrialDays` | 7 | 商家赠送体验会员有效天数（可配置） |
| 商家赠送最高等级 | `merchantMaxGiftLevel` | 3 | 商家可赠送的最高VIP等级（固定） |
| 平台会员折扣 | `platformDiscount` | 95% | 平台定义各等级折扣（可配置） |
| 商户平日折扣 | `weekdayDiscount` | 95% | 商户设置（可配置，≤ 平台折扣） |
| 商户周末折扣 | `weekendDiscount` | 95% | 商户设置（可配置，≤ 平台折扣） |
| 商户节假日折扣 | `holidayDiscount` | 95% | 商户设置（可配置，≤ 平台折扣） |

---

## 八、业务场景示例

### 场景1：用户赠送体验会员
```
A用户（VIP3）赠送B用户VIP3体验会员
↓
B用户点击接受（2025-01-12 10:00）
↓
系统检查：B用户当前VIP2 < VIP3，可接受
↓
生效时间：2025-01-13 00:00（次日0点）
到期时间：2025-01-19 23:59（7天后）
↓
B用户会员等级展示：VIP3（体验）
```

### 场景2：等级冲突拒绝
```
商家赠送VIP2体验会员
↓
C用户点击接受
↓
系统检查：C用户当前VIP3 >= VIP2
↓
拒绝接受，提示"您已是更高等级会员"
```

### 场景3：升级流程
```
用户当前VIP1（累计12晚）
↓
完成订单3晚（累计15晚）
↓
订单离店（状态 → checked_out）
↓
系统检测：15晚 >= VIP2升级条件
↓
立即升级为VIP2
设置 upgradedThisYear = true
有效期延长至次年12月31日
重置 maintainNights = 0
```

### 场景4：年度保级检测
```
2025年12月30日23:59
↓
系统检测所有会员
↓
用户D：VIP3, upgradedThisYear=false, maintainNights=8晚
VIP3保级要求：15晚
↓
未达标，降级为VIP2
有效期延长至2026年12月31日
重置 maintainNights = 0
```

---

## 九、代码实现要点

### 9.1 类型定义位置

**主要文件**:
- `app/pages/PlatformAdmin/MemberManagement/types/member.types.ts`
- `app/pages/MerchantBackend/OldCustomer/types/inviteMember.types.ts`

### 9.2 定时任务

**需要实现的定时任务：**
1. 年度重置：每年1月1日 00:00
2. 年度保级检测：每年12月30日 23:59
3. 体验会员到期检查：每天凌晨

### 9.3 状态转换触发点

**订单离店时**:
- 累加间夜数（totalNights, yearUpgradeNights, maintainNights）
- 检测升级条件
- 发放积分和会员权益

**会员邀请时**:
- 创建邀请记录
- 生成邀请码/二维码

**接受赠送时**:
- 等级冲突检查
- 计算生效时间和到期时间
- 更新用户会员信息

---

**最后更新**: 2025-11-27
**文档维护**: 所有涉及会员规则的修改，必须同步更新此白皮书
