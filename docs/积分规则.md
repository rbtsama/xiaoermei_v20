# 积分规则白皮书

> **版本**: v1.0
> **更新时间**: 2025-11-27
> **用途**: 积分获取、使用、过期规则参考文档

---

## 一、积分定义

**积分** 是平台用户忠诚度计划的核心，用户可通过多种方式获得积分，并使用积分抵扣订单金额或兑换增值服务。

---

## 二、积分过期规则

### 规则：次年年末统一过期

**示例：**
- 2025年获得的积分 → 2026年12月31日 23:59:59 过期
- 2026年获得的积分 → 2027年12月31日 23:59:59 过期

**配置参数：**
```typescript
{
  expiryRule: {
    expiryYears: 1  // 次年年末（固定为1）
  }
}
```

---

## 三、积分获得规则

### 3.1 新用户注册奖励

**规则**: 新注册用户获得积分奖励

**可配置参数：**
```typescript
{
  registerRewardPoints: 30  // 注册奖励积分（可配置）
}
```

**触发时机**: 用户完成微信授权注册后立即发放

**注意**:
- ✅ C端用户自主注册：获得积分
- ❌ 商户邀请的新注册：**不获得**积分

---

### 3.2 邀请好友奖励

**规则**: 用户邀请用户注册，受邀人首单离店后，邀请人获得积分

**可配置参数：**
```typescript
{
  inviteRewardPoints: 30  // 邀请奖励积分（可配置）
}
```

**触发条件：**
1. A用户邀请B用户注册
2. B用户下单并完成支付
3. B用户首单状态变为 `checked_out`（已离店）
4. 系统自动给A用户发放邀请奖励积分

**重要区分：**
- ✅ C端用户邀请：受邀人首单离店后，邀请人获得积分
- ❌ 商户邀请：受邀人**不获得**注册积分，邀请人**不获得**邀请奖励

**字段定义：**
```typescript
{
  inviterId: string           // 邀请人ID
  inviteSource: 'user' | 'merchant'  // 邀请来源
  isFirstOrder: boolean       // 是否首单
}
```

---

### 3.3 环保奖励积分（绿色环保）

**规则**: 用户选择环保选项，离店后获得积分奖励

**环保选项示例：**
- 不使用一次性拖鞋
- 不使用一次性牙刷
- 不更换床单
- 不更换毛巾

**配置方式：**
- 平台在"积分管理 > 积分增值服务"中定义可选服务项和积分值
- 商户在"积分服务 > 服务配置"中选择本店支持的服务项

**示例配置：**
```typescript
{
  id: 'eco-001',
  name: '不使用一次性拖鞋',
  type: 'eco_reward',          // 环保奖励
  pointsAmount: 5,             // 积分值（可配置）
  enabled: true,
}
```

**触发时机**: 订单状态变为 `checked_out`（已离店）时发放

---

## 四、积分使用规则

### 4.1 积分抵扣RMB

**汇率配置：**
```typescript
{
  baseExchangeRate: 10  // X积分 = 1元（可配置，如10积分=1元）
}
```

**最大抵扣比例：**
```typescript
{
  maxDeductionPercent: 30  // 单笔订单最多可抵扣30%（可配置）
}
```

**计算公式：**
```typescript
// 1. 按汇率计算可抵扣金额
抵扣金额 = Math.floor(使用积分 / 汇率)

// 2. 按最大比例限制
最大抵扣金额 = 订单金额 × 最大抵扣比例
实际抵扣金额 = Math.min(抵扣金额, 最大抵扣金额)

// 3. 反算实际消耗积分
实际消耗积分 = 实际抵扣金额 × 汇率
```

**使用时机**: 下单时选择使用积分，立即扣除

**示例：**
- 订单金额: 1000元
- 用户积分: 500积分
- 汇率: 10积分=1元
- 最大抵扣比例: 30%

计算过程：
1. 500积分可抵扣50元
2. 订单最多可抵扣300元（1000×30%）
3. 实际抵扣50元，消耗500积分
4. 最终支付950元

---

### 4.2 积分换购增值服务

**规则**: 用户使用积分兑换酒店提供的增值服务

**服务示例：**
- 欢迎水果（20积分）
- 延迟退房（50积分）
- 接送机服务（100积分）

**配置方式：**
- 平台定义：服务项名称、所需积分、是否启用
- 商户选择：从平台定义的服务中，选择本店支持的项目

**使用时机**: 下单时选择服务，立即扣除积分

---

## 五、积分扣除与返还规则

### 5.1 下单时扣除

**扣除项：**
1. 积分抵扣（兑换RMB）
2. 积分换购增值服务

**扣除时机**: 用户下单时立即扣除

---

### 5.2 取消订单返还

**规则**: 取消订单时，已扣除的积分全额返还

**返还条件：**
- ✅ 订单状态为 `pending_payment`（待付款）
- ✅ 订单状态为 `pending_checkin`（待入住）

**不可返还条件：**
- ❌ 订单状态为 `checked_in`（已入住）- **入住后不可退**
- ❌ 订单状态为 `checked_out`（已离店）
- ❌ 订单状态为 `completed`（已完成）

**返还逻辑：**
```typescript
if (order.status === 'pending_payment' || order.status === 'pending_checkin') {
  // 入住前取消，全额返还积分
  refundPoints = order.pointsUsed || 0
} else {
  // 入住后，积分不可退
  refundPoints = 0
}
```

---

## 六、平台管理功能

### 6.1 积分发放与回收

**功能**: 平台可手动给用户发放或回收积分

**操作方式：**
- 进入"平台后台 > 积分管理 > 积分调整"
- 选择用户
- 选择操作类型：增加/减少
- 输入积分数量和原因
- 确认调整

---

### 6.2 积分汇率配置

**功能**: 平台可修改积分抵扣RMB的汇率

**配置路径**: 平台后台 > 积分管理 > 积分规则配置

**配置项：**
```typescript
{
  baseExchangeRate: number  // X积分 = 1元（可配置，建议10-20）
}
```

---

### 6.3 最大抵扣比例配置

**功能**: 平台可设定单笔订单积分最大抵扣比例

**配置路径**: 平台后台 > 积分管理 > 积分规则配置

**配置项：**
```typescript
{
  maxDeductionPercent: number  // 最大抵扣比例（0-100，建议20-50）
}
```

---

### 6.4 积分增值服务配置

**功能**: 平台定义可选服务项及对应积分值

**配置路径**: 平台后台 > 积分管理 > 积分增值服务

**服务类型：**
1. **积分奖励**（eco_reward）：用户选择环保选项，离店后获得积分
2. **积分换购**（value_added）：用户消耗积分兑换增值服务

**配置项：**
```typescript
{
  id: string
  name: string                 // 服务名称（如"不使用拖鞋"）
  type: 'eco_reward' | 'value_added'
  pointsAmount: number         // 积分值（可配置）
  enabled: boolean             // 是否启用
}
```

**商户选择：**
- 商户在"商户端 > 积分服务 > 服务配置"中
- 查看平台定义的所有服务项
- 选择启用/禁用本店支持的服务

---

## 七、核心字段定义

### 7.1 用户积分账户

```typescript
{
  userId: string
  currentPoints: number        // 当前可用积分
  totalEarned: number          // 累计获得积分
  totalUsed: number            // 累计使用积分
  totalExpired: number         // 累计过期积分
}
```

### 7.2 积分流水记录

```typescript
{
  id: string
  userId: string
  changeType: 'earn' | 'use' | 'refund' | 'expire' | 'adjust'
  amount: number               // 积分数量（正数=增加，负数=减少）
  source: string               // 来源说明
  orderId?: string             // 关联订单ID
  createdAt: string            // 创建时间
  expiresAt?: string           // 过期时间（仅获得积分时有）
}
```

### 7.3 订单中的积分字段

```typescript
{
  // 积分使用
  pointsUsed: number           // 使用积分数量
  pointsDeductAmount: number   // 积分抵扣金额
  valueAddedPoints: number     // 增值服务积分

  // 积分奖励
  ecoRewardPoints: number      // 环保奖励积分（离店后发放）

  // 积分退还
  pointsRefundable: boolean    // 积分是否可退（入住后=false）
}
```

---

## 八、配置参数汇总

| 参数名称 | 字段名 | 默认值 | 说明 |
|---------|--------|--------|------|
| 注册奖励积分 | `registerRewardPoints` | 30 | 新用户注册奖励 |
| 邀请奖励积分 | `inviteRewardPoints` | 30 | 邀请好友注册奖励（首单离店触发） |
| 积分汇率 | `baseExchangeRate` | 10 | X积分=1元 |
| 最大抵扣比例 | `maxDeductionPercent` | 30 | 单笔订单最多抵扣X% |
| 积分有效期 | `expiryYears` | 1 | 次年年末过期 |

---

## 九、开票规则

### 规则：积分抵扣部分不可开票

**说明**:
- 积分属于平台营销奖励，积分抵扣的部分不产生实际现金流，因此不可开具发票
- 用户线下申请发票时，发票金额 = 订单实付金额（不含积分抵扣部分）
- 系统内不实现发票管理功能，仅需在订单记录中明确区分金额

**计算示例：**
```
订单总额 = 1000元
积分抵扣 = 100元
实付金额 = 900元

可开票金额 = 900元（实付金额）
```

---

## 十、配置参数汇总

| 参数名称 | 字段名 | 默认值 | 说明 |
|---------|--------|--------|------|
| 注册奖励积分 | `registerRewardPoints` | 30 | 新用户注册奖励（可配置） |
| 邀请奖励积分 | `inviteRewardPoints` | 30 | 邀请好友奖励（可配置，首单离店触发） |
| 积分汇率 | `baseExchangeRate` | 10 | X积分=1元（可配置） |
| 最大抵扣比例 | `maxDeductionPercent` | 30 | 单笔订单最多抵扣X%（可配置） |
| 积分有效期 | `expiryYears` | 1 | 次年年末过期（固定） |

---

## 十一、业务场景示例

### 场景1：新用户注册
```
用户微信授权注册
↓
系统检查邀请来源
├─ 来源：C端用户邀请 → 发放30积分（可配置）
└─ 来源：商户邀请 → 不发放积分
```

### 场景2：邀请好友下单
```
A用户邀请B用户注册
↓
B用户下单并支付（订单1）
↓
B用户入住
↓
B用户离店（订单状态 → checked_out）
↓
系统检查：B用户首单 + 已离店
↓
给A用户发放30积分（可配置）
```

### 场景3：下单使用积分
```
用户下单，订单金额1000元
↓
选择使用积分抵扣（输入500积分）
↓
系统计算：
- 汇率10，500积分=50元
- 最大抵扣30%，1000×30%=300元
- 实际抵扣50元，消耗500积分
↓
下单时立即扣除500积分
↓
最终支付950元
```

### 场景4：取消订单退积分
```
订单状态：pending_checkin（待入住）
↓
用户申请取消订单
↓
系统检查：未入住，可退积分
↓
返还500积分到用户账户
```

### 场景5：入住后退款（积分不退）
```
订单状态：checked_in（已入住）
↓
用户申请退款
↓
商家同意退款（退房费）
↓
系统检查：已入住
↓
退款：仅退房费部分
积分：抵扣积分和增值服务积分不退
```

### 场景6：环保奖励
```
用户下单时选择：不使用一次性拖鞋（+5积分）
↓
订单完成入住
↓
订单离店（状态 → checked_out）
↓
系统发放环保奖励积分5分
```

---

## 十、开票规则

### 规则：积分抵扣部分不可开票

**计算公式：**
```typescript
订单总额 = 1000元
积分抵扣 = 100元
实付金额 = 900元

可开票金额 = 实付金额 = 900元
不可开票部分 = 积分抵扣 = 100元
```

**发票字段：**
```typescript
{
  orderAmount: 1000,          // 订单总额
  pointsDeductAmount: 100,    // 积分抵扣（不可开票）
  invoiceableAmount: 900,     // 可开票金额
}
```

---

## 十一、核心字段定义

### 11.1 积分基础配置

```typescript
interface PointsBaseRuleConfig {
  // 注册与邀请
  registerRewardPoints: number     // 注册奖励积分（可配置）
  inviteRewardPoints: number       // 邀请奖励积分（可配置）

  // 积分使用
  baseExchangeRate: number         // 积分汇率（X积分=1元，可配置）
  maxDeductionPercent: number      // 最大抵扣比例（可配置）

  // 积分过期
  expiryYears: number              // 次年年末过期（固定为1）
}
```

### 11.2 积分增值服务配置

```typescript
interface PointsServiceItem {
  id: string
  name: string                     // 服务名称
  type: 'eco_reward' | 'value_added'  // 服务类型
  pointsAmount: number             // 积分值（可配置）
  description?: string             // 服务说明
  enabled: boolean                 // 平台是否启用
}
```

### 11.3 商户积分服务配置

```typescript
interface MerchantPointsServiceConfig {
  hotelId: string

  // 环保奖励（商户启用的项目）
  ecoRewards: {
    serviceId: string              // 对应平台服务ID
    enabled: boolean               // 商户是否启用
  }[]

  // 增值服务（商户启用的项目）
  valueAddedServices: {
    serviceId: string
    enabled: boolean
  }[]
}
```

### 11.4 用户积分流水

```typescript
interface PointsRecord {
  id: string
  userId: string

  // 变动信息
  changeType: 'earn' | 'use' | 'refund' | 'expire' | 'adjust'
  amount: number                   // 积分数量（+增加，-减少）
  balance: number                  // 变动后余额

  // 来源信息
  source: string                   // 来源说明
  orderId?: string                 // 关联订单
  inviterId?: string               // 邀请人ID（邀请奖励时）

  // 时间信息
  createdAt: string                // 创建时间
  expiresAt?: string               // 过期时间（获得积分时计算）
}
```

---

## 十二、配置检查清单

### 平台后台 - 积分管理

- [ ] 积分规则配置（BaseRuleConfigPage）
  - [ ] 注册奖励积分（可配置）
  - [ ] 邀请奖励积分（可配置）
  - [ ] 积分汇率（可配置）
  - [ ] **缺失：最大抵扣比例**
  - [ ] **缺失：积分过期规则**

- [ ] 积分增值服务（ValueAddedServicesPage）
  - [ ] 环保奖励服务配置（可配置积分值）
  - [ ] 增值服务配置（可配置积分值）

- [ ] 积分调整（PointsAdjustmentPage）
  - [ ] 手动发放积分
  - [ ] 手动回收积分

### 商户端 - 积分服务

- [ ] 积分服务配置（PointsServiceConfigPage）
  - [ ] 查看平台定义的服务项
  - [ ] 启用/禁用本店支持的服务

### C端 - 积分使用

- [ ] 订单确认页（OrderConfirmPage）
  - [ ] 积分抵扣输入
  - [ ] 增值服务选择
  - [ ] 实时计算抵扣金额

- [ ] 我的积分（MyPointsPage）
  - [ ] 积分余额显示
  - [ ] 积分流水记录
  - [ ] 过期提示

---

**最后更新**: 2025-11-27
**文档维护**: 所有涉及积分规则的修改，必须同步更新此白皮书
