# 订单生命周期白皮书

> **版本**: v1.0
> **更新时间**: 2025-11-27
> **用途**: 订单状态规则、字段定义参考文档

---

## 一、订单状态定义

### 1.1 核心状态（6个）

| 序号 | 状态名称 | 代码值 | 说明 |
|------|---------|--------|------|
| 1 | 待付款 | `pending_payment` | 用户下单、商户代客下单 - 支付前 |
| 2 | 待入住 | `pending_checkin` | 用户完成支付 - 入住前 |
| 3 | 已入住 | `checked_in` | 商家确认入住 or 入住日次日6点自动 |
| 4 | 已离店 | `checked_out` | 商家确认离店 or 离店当日24点自动 |
| 5 | 已完成 | `completed` | 离店日+3天24点自动 |
| 6 | 已取消 | `cancelled` | 支付超时取消 or 入住前取消 |

### 1.2 业务规则说明

#### 1. 待付款 (pending_payment)
- **触发**: 用户下单 或 商户代客下单
- **特点**: 会临时占房
- **配置**: 可分别设置下单可支付时间和代客下单时间
- **转换**: 支付成功 → 待入住；支付超时 → 已取消

#### 2. 待入住 (pending_checkin)
- **触发**: 用户完成支付
- **转换**: 商家确认入住 or 入住日次日6点 → 已入住

#### 3. 已入住 (checked_in)
- **触发**: 商家确认入住 or 入住日次日6点自动
- **转换**: 商家确认离店 or 离店当日24点 → 已离店

#### 4. 已离店 (checked_out)
- **触发**: 商家确认离店 or 离店当日24点自动
- **转换**: 离店日+3天24点 → 已完成

#### 5. 已完成 (completed)
- **触发**: 离店日+3天24点自动
- **作用**: 冻结账务，不再有退款和订单带来的积分变化
- **配置**: +N天可配置

#### 6. 已取消 (cancelled)
- **触发**: 支付超时取消 or 入住前取消

---

## 二、状态流转规则

### 2.1 正常流程

```
待付款 → 待入住 → 已入住 → 已离店 → 已完成
```

### 2.2 异常流程

```
待付款 → 已取消 (支付超时)
待入住 → 已取消 (入住前取消)
```

### 2.3 自动转换时间点

| 源状态 | 目标状态 | 触发时间 |
|--------|---------|---------|
| 待付款 | 已取消 | 下单后N分钟（可配置） |
| 待入住 | 已入住 | 入住日次日 6:00 |
| 已入住 | 已离店 | 离店当日 24:00 |
| 已离店 | 已完成 | 离店日+3天 24:00 |

---

## 三、核心字段定义

### 3.1 订单基本字段

```typescript
{
  id: string                    // 订单ID
  orderNo: string               // 订单号
  status: OrderStatus           // 订单状态（6选1）

  // 用户信息
  userId: string
  userName: string
  userPhone: string

  // 酒店信息
  hotelId: string
  hotelName: string
  roomTypeId: string
  roomTypeName: string

  // 日期信息
  checkInDate: string           // 入住日期（YYYY-MM-DD）
  checkOutDate: string          // 离店日期（YYYY-MM-DD）
  nights: number                // 入住晚数

  // 金额信息
  totalAmount: number           // 订单总金额
  paidAmount: number            // 实付金额

  // 时间戳
  createdAt: string             // 下单时间
  paidAt?: string               // 支付时间

  // 特殊标记
  isAgentOrder: boolean         // 是否代客下单
}
```

### 3.2 状态相关字段

```typescript
{
  // 待付款
  paymentDeadline?: string      // 支付截止时间

  // 已入住
  actualCheckInTime?: string    // 实际入住时间
  roomNumber?: string           // 房间号

  // 已离店
  actualCheckOutTime?: string   // 实际退房时间

  // 已完成
  completedAt?: string          // 完成时间

  // 已取消
  cancelledAt?: string          // 取消时间
  cancelledBy?: string          // 取消人（user/merchant/system）
}
```

---

## 四、配置参数

### 4.1 自动转换时间配置

```typescript
AUTO_TRANSITION_RULES = {
  PAYMENT_TIMEOUT_MINUTES: 30,           // C端支付超时（分钟）
  AGENT_ORDER_TIMEOUT_HOURS: 24,         // 代客下单支付超时（小时）
  CHECKIN_AUTO_HOUR: 6,                  // 自动入住时间（6:00）
  CHECKOUT_AUTO_HOUR: 24,                // 自动退房时间（24:00）
  COMPLETION_DELAY_DAYS: 3,              // 自动完成延迟天数
}
```

### 4.2 库存占用规则

| 订单状态 | 库存状态 |
|---------|---------|
| 待付款 | 临时占用 |
| 待入住 | 正式占用 |
| 已入住 | 正式占用 |
| 已离店 | 已释放 |
| 已完成 | 已释放 |
| 已取消 | 已释放 |

---

## 五、前端显示规范

### 5.1 状态标签

```typescript
ORDER_STATUS_LABELS = {
  'pending_payment': '待付款',
  'pending_checkin': '待入住',
  'checked_in': '已入住',
  'checked_out': '已离店',
  'completed': '已完成',
  'cancelled': '已取消',
}
```

### 5.2 状态颜色

```typescript
ORDER_STATUS_COLORS = {
  'pending_payment': 'orange',   // 橙色
  'pending_checkin': 'blue',     // 蓝色
  'checked_in': 'green',         // 绿色
  'checked_out': 'purple',       // 紫色
  'completed': 'slate',          // 灰色
  'cancelled': 'red',            // 红色
}
```

---

## 六、代码实现要点

### 6.1 类型定义位置

**唯一数据源**: `app/pages/SharedTypes/order.types.ts`

所有模块必须从此处导入，不得自定义订单状态类型。

### 6.2 状态使用规范

**✅ 正确**:
```typescript
import { OrderStatus, ORDER_STATUS_LABELS } from '~/pages/SharedTypes/order.types'

if (order.status === OrderStatus.PENDING_CHECKIN) { ... }
```

**❌ 错误**:
```typescript
if (order.status === 'pending') { ... }  // 硬编码
```

---

**最后更新**: 2025-11-27
**文档维护**: 所有涉及订单状态的修改，必须同步更新此白皮书
